Metadata-Version: 2.4
Name: agent-hub
Version: 0.1.0
Summary: Agent-native GitHub clone MVP
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: fastapi>=0.111.0
Requires-Dist: uvicorn>=0.30.0
Requires-Dist: sqlalchemy>=2.0.30
Requires-Dist: alembic>=1.13.0
Requires-Dist: psycopg[binary]>=3.2.0
Requires-Dist: httpx>=0.27.0
Requires-Dist: pydantic>=2.7.0
Requires-Dist: pydantic-settings>=2.4.0
Requires-Dist: PyJWT>=2.8.0
Provides-Extra: dev
Requires-Dist: pytest>=8.2.0; extra == "dev"
Provides-Extra: llm
Requires-Dist: openai>=1.50.0; extra == "llm"

# Agent Hub

Agent Hub is a GitHub-style backend built for autonomous software agents.
Humans provide high-level objectives; agents decompose, implement, validate, review, and merge work with policy controls.

## Production-Ready Baseline Included

- FastAPI API with typed schemas and SQLAlchemy models
- Git-backed execution engine (clone, branch, commit, merge)
- Pluggable provider layer (`rule_based`, optional `openai`)
- Automation policy controls (`auto_triage`, `auto_assign`, `auto_review`, `auto_merge`, approval/test gates)
- Per-request observability (`X-Request-ID`, latency logging)
- API-key protection for mutating endpoints
- Optional JWT auth with role enforcement (`admin`, `maintainer`, `viewer`)
- Async autopilot job queue with background worker
- GitHub sync endpoint for opening remote PRs + commit statuses
- Prometheus-compatible `/metrics` endpoint
- CI workflow (`.github/workflows/ci.yml`)
- Container build files (`Dockerfile`, `.dockerignore`)

## Core Architecture

- API: `app/main.py`
- DB setup/session: `app/db.py`
- Domain models: `app/models.py`
- Orchestration loop: `app/orchestration.py`
- Git workspace manager: `app/git_ops.py`
- Provider abstraction: `app/providers.py`
- Job queue + worker: `app/job_queue.py`, `app/job_worker.py`
- Runtime config: `app/config.py`
- Security/auth dependencies: `app/security.py`, `app/auth.py`, `app/permissions.py`
- Repo path validation: `app/repo_security.py`

## Environment Setup

Install prerequisites before running this project:

- `git`
- `python` 3.11+
- `uv`

Install `uv` (official installer):

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

If `curl` is unavailable:

```bash
wget -qO- https://astral.sh/uv/install.sh | sh
```

Alternative install methods:

```bash
brew install uv
pipx install uv
```

If you see `zsh: command not found: uv`, your `PATH` likely does not include `~/.local/bin`.
Add it and reload your shell:

```bash
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

Verify:

```bash
uv --version
python3 --version
```

Common setup errors:

- `zsh: command not found: uv`:
  - install `uv` and ensure `~/.local/bin` is in `PATH` (see commands above)
- `error: Failed to spawn: alembic`:
  - install/sync dev dependencies:
    ```bash
    uv sync --extra dev
    ```
  - then rerun:
    ```bash
    make db-upgrade
    # or
    make smoke
    ```

## Quickstart (Local)

```bash
uv sync --extra dev
uv run uvicorn app.main:app --reload
```

Open API docs at `http://127.0.0.1:8000/docs`.

## Optional LLM Provider (OpenAI)

```bash
uv sync --extra dev --extra llm
export AGENT_HUB_PROVIDER=openai
export OPENAI_API_KEY=your_key_here
```

## Security Configuration

To require API keys for write operations (`POST`, `PATCH` endpoints):

```bash
export AGENT_HUB_REQUIRE_API_KEY=1
export AGENT_HUB_API_KEYS=key_one,key_two
```

Use either header:

- `X-API-Key: key_one`
- `Authorization: Bearer key_one`

To enforce bearer-role checks on all write endpoints:

```bash
export AGENT_HUB_AUTH_REQUIRE_ROLES=1
export AGENT_HUB_JWT_SECRET=replace-with-strong-32-plus-char-secret
```

Issue a JWT (requires API key mode enabled):

```bash
curl -sX POST http://127.0.0.1:8000/auth/token \
  -H 'content-type: application/json' \
  -H 'X-API-Key: key_one' \
  -d '{"subject":"ci-bot","role":"maintainer"}'
```

## Runtime Configuration

- `AGENT_HUB_APP_ENV`: environment label (`development`, `staging`, `production`)
- `AGENT_HUB_LOG_LEVEL`: logging level (default: `INFO`)
- `AGENT_HUB_DATABASE_URL`: SQLAlchemy DB URL (default: `sqlite:///./agent_hub.db`)
- `AGENT_HUB_REQUIRE_API_KEY`: require API keys on mutating endpoints (`0` default)
- `AGENT_HUB_API_KEYS`: comma-separated API keys
- `AGENT_HUB_AUTH_REQUIRE_ROLES`: require bearer JWT role checks on mutating endpoints (`0` default)
- `AGENT_HUB_JWT_SECRET`: HS256 secret for JWT verification/issuance
- `AGENT_HUB_JWT_TTL_SECONDS`: token lifetime in seconds (default: `3600`)
- `AGENT_HUB_WORKSPACES`: directory for git execution workspaces (default: `.agent_workspaces`)
- `AGENT_HUB_ALLOW_LOCAL_REPO_PATHS`: allow local repo paths (`1` default)
- `AGENT_HUB_ALLOWED_LOCAL_REPO_ROOT`: optional root path restriction for local repos
- `AGENT_HUB_GIT_COMMAND_TIMEOUT_SEC`: git command timeout (default: `60`)
- `AGENT_HUB_GIT_COMMAND_RETRIES`: retries for transient git failures (default: `1`)
- `AGENT_HUB_JOB_WORKER_ENABLED`: enable background job worker (`1` default)
- `AGENT_HUB_JOB_WORKER_POLL_INTERVAL_SEC`: worker poll interval seconds (default: `1.0`)
- `AGENT_HUB_JOB_STALE_TIMEOUT_SEC`: stale `running` job timeout in seconds before recovery (default: `900`)
- `AGENT_HUB_PROVIDER`: provider key (`rule_based`, `openai`)
- `AGENT_HUB_PROVIDER_FALLBACK`: fallback to `rule_based` if provider init fails (`1` default)
- `AGENT_HUB_OPENAI_MODEL`: model for `openai` provider (default: `gpt-4.1-mini`)
- `AGENT_HUB_OPENAI_TIMEOUT_SEC`: OpenAI timeout seconds (default: `45`)
- `AGENT_HUB_TEST_CMD`: optional validation command run in workspace
- `AGENT_HUB_AUTO_PUSH`: push branch/default branch after merge (`0` default)
- `AGENT_HUB_RATE_LIMIT_ENABLED`: enable in-memory rate limiting for write endpoints (`0` default)
- `AGENT_HUB_RATE_LIMIT_REQUESTS_PER_MINUTE`: write request limit per minute per client IP (default: `120`)
- `AGENT_HUB_GITHUB_WEBHOOK_SECRET`: optional GitHub webhook signing secret (validates `X-Hub-Signature-256`)
- `AGENT_HUB_GITHUB_WEBHOOK_AUTO_ENQUEUE`: auto-enqueue autopilot job for `issues:opened` webhooks (`0` default)

## GitHub Webhooks

`POST /webhooks/github` consumes raw GitHub webhook payloads and supports:

- `issues` with action `opened`: creates a project objective from issue title/body
- `issue_comment` with action `created`: enqueues a job when comment contains `/agent run`

Repository mapping is resolved via owner/repo matching (including `https://github.com/...`, `git@github.com:...`, and API URL forms).  
If `AGENT_HUB_GITHUB_WEBHOOK_SECRET` is set, requests must include a valid `X-Hub-Signature-256` HMAC SHA-256 signature.
Webhook requests also require `X-GitHub-Delivery`; deliveries are persisted and deduplicated by this id.  
Duplicate delivery ids return `{"action":"ignored","reason":"Duplicate delivery"}` and do not trigger side effects.

## API Flow

1. Create project: `POST /projects`
2. Bootstrap agents: `POST /projects/{project_id}/bootstrap`
3. Optional manual lifecycle management: `GET /projects/{project_id}/agents`, `POST /projects/{project_id}/agents`, `PATCH /projects/{project_id}/agents/{agent_id}`
4. Create objective: `POST /projects/{project_id}/objectives`
5. Tune policy: `PATCH /projects/{project_id}/policy`
6. Run synchronously: `POST /projects/{project_id}/autopilot/run`
7. Or queue async execution: `POST /projects/{project_id}/jobs/autopilot`
8. Cancel or retry async jobs: `POST /projects/{project_id}/jobs/{job_id}/cancel`, `POST /projects/{project_id}/jobs/{job_id}/retry`
9. Inspect: `/dashboard`, `/events`, `/work-items`, `/runs`, `/pull-requests`, `/projects/{id}/jobs`, `/metrics`
10. Sync local PR metadata to GitHub: `POST /projects/{id}/pull-requests/{pr_id}/github/sync`
11. Receive inbound GitHub webhooks: `POST /webhooks/github`

### Example

```bash
curl -sX POST http://127.0.0.1:8000/projects \
  -H 'content-type: application/json' \
  -d '{"name":"acme-api","repo_url":"https://github.com/acme/api","default_branch":"main"}'

curl -sX POST http://127.0.0.1:8000/projects/1/bootstrap

curl -sX POST http://127.0.0.1:8000/projects/1/objectives \
  -H 'content-type: application/json' \
  -d '{"objective":"Reduce flaky tests; improve auth edge-case coverage","max_work_items":2,"created_by":"system"}'

curl -sX PATCH http://127.0.0.1:8000/projects/1/policy \
  -H 'content-type: application/json' \
  -d '{"auto_merge":true,"min_review_approvals":1}'

curl -sX POST http://127.0.0.1:8000/projects/1/autopilot/run \
  -H 'content-type: application/json' \
  -d '{"max_items":2}'

curl -sX POST http://127.0.0.1:8000/projects/1/jobs/autopilot \
  -H 'content-type: application/json' \
  -d '{"max_items":2,"requested_by":"scheduler"}'

curl -sX POST http://127.0.0.1:8000/projects/1/jobs/1/retry
```

## Health and Metrics

- `GET /health`
- `GET /health/live`
- `GET /health/ready`
- `GET /metrics`
  - Includes `agent_hub_autopilot_jobs_stale_recovered_total`

## Development Commands

```bash
make install
make test
make smoke
make run
make docker-build
make db-upgrade
```

## Smoke Test

Run `make smoke` to execute an end-to-end API smoke flow with temporary infrastructure:

- creates a temporary git repository and SQLite database
- applies migrations
- starts the API in secure mode (API key + JWT role enforcement)
- validates project/bootstrap/objective/autopilot/job-retry flows
- validates GitHub webhook signature handling + delivery-id deduplication

## Container Run

```bash
docker build -t agent-hub:latest .
docker run --rm -p 8000:8000 agent-hub:latest
```

## Remaining Work Before Large-Scale Production

- Expand migration coverage with forward-only data migrations
- Background job queue + worker autoscaling
- Multi-tenant authn/authz (JWT/OIDC + RBAC)
- GitHub/GitLab native PR/check integration
- Distributed tracing and centralized log shipping
- Stateful policy/audit management UI
